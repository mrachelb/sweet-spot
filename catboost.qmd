---
title: "Catboost Modelling"
author: "Alex, Rachel, Vlatko, Malte"
date: "2024-06-20"
format: html
execute: 
  cache: true
  echo: false
  error: true
jupyter: python3
editor:
  render-on-save: true
---

```{python}

import pandas as pd
import numpy as np
import matplotlib.pyplot as plt
import matplotlib.dates as md
import seaborn as sns
import datetime as dt

from sklearn.impute import SimpleImputer, KNNImputer 
from sklearn.preprocessing import OneHotEncoder, RobustScaler, FunctionTransformer, PolynomialFeatures
from sklearn.compose import ColumnTransformer
from sklearn.pipeline import Pipeline
from sklearn.model_selection import cross_validate, RandomizedSearchCV
from sklearn.linear_model import LinearRegression, Ridge, Lasso, ElasticNet
from sklearn.metrics import mean_absolute_percentage_error, r2_score, mean_squared_error

from sklearn.model_selection import TimeSeriesSplit, StratifiedKFold
from statsmodels.tsa.stattools import adfuller

from catboost import CatBoostRegressor
from xgboost import XGBRegressor
import optuna 
```


```{python}
%run functions_model.py
```

```{python}
! jupyter nbextension enable widgetsnbextension --py
```

```{python}
pd.set_option("display.max_columns", None)
```


# Loading the dataset

```{python}
d = pd.read_csv("data/train_df.csv")
d_test = pd.read_csv("data/test_df.csv")
```


```{python}
d['date'] = pd.to_datetime(d['date'])
d_test['date'] = pd.to_datetime(d_test['date'])
```



# Creating validation dataset

```{python}
train, val = create_val_set(d)
```



# Modelling

## Catboost

### Selecting features

```{python}

date = ["date"]

catfeat = ["store_name","item_category","hol_pub","hol_school","weekday","day","month","year","week_year","nye","valentines_day","halloween", "street_market","public_space","box_deal"]

numfeat = ["days_back","temperature_2m_mean","sunshine_duration","precipitation_hours"]

lag = ["lag1","lag2"]

```



```{python}

x_train = train[date + catfeat + numfeat + lag]
x_train = x_train.set_index("date")
x_train_daily = x_train[(x_train["item_category"] == "daily total") & (x_train["store_name"] != "KaDeWe")]
y_train = train['total_amount']
y_train_daily = train[(train["item_category"] == "daily total") & (train["store_name"] != "KaDeWe")]['total_amount']

x_val = val[date + catfeat + numfeat + lag]
x_val = x_val.set_index("date")
x_val_daily = x_val[(x_val["item_category"] == "daily total") & (x_val["store_name"] != "KaDeWe")]
y_val = val['total_amount']
y_val_daily = val[(val["item_category"] == "daily total") & (val["store_name"] != "KaDeWe")]['total_amount']

x_test = d_test[date + catfeat + numfeat]
x_test = x_test.set_index("date")
x_test_daily = x_test[(x_test["item_category"] == "daily total") & (x_test["store_name"] != "KaDeWe")]
y_test = d_test['total_amount']
y_test_daily = d_test[(d_test["item_category"] == "daily total") & (d_test["store_name"] != "KaDeWe")]['total_amount']

```



### Convert holiday features to integer

```{python}

x_train["hol_pub"] = x_train["hol_pub"].apply(np.int64)
x_train["hol_school"] = x_train["hol_school"].apply(np.int64)
x_train_daily["hol_pub"] = x_train_daily["hol_pub"].apply(np.int64)
x_train_daily["hol_school"] = x_train_daily["hol_school"].apply(np.int64)

x_val["hol_pub"] = x_val["hol_pub"].apply(np.int64)
x_val["hol_school"] = x_val["hol_school"].apply(np.int64)
x_val_daily["hol_pub"] = x_val_daily["hol_pub"].apply(np.int64)
x_val_daily["hol_school"] = x_val_daily["hol_school"].apply(np.int64)

x_test["hol_pub"] = x_test["hol_pub"].apply(np.int64)
x_test["hol_school"] = x_test["hol_school"].apply(np.int64)
x_test_daily["hol_pub"] = x_test_daily["hol_pub"].apply(np.int64)
x_test_daily["hol_school"] = x_test_daily["hol_school"].apply(np.int64)

```


### Custom CV split

```{python}
val1 = x_train_daily[x_train_daily.index.between("2024-05-17","2024-05-24")]
train = x_train_daily[x_train_daily.index.between("2024-05-17","2024-05-24")]
```


### Hyperparameter Tuning


```{python}

def objective(trial):
    params = {
        'n_estimators': trial.suggest_int('n_estimators', 1000, 5000),
        "learning_rate": trial.suggest_float("learning_rate", 1e-3, 0.1, log=True),
        "depth": trial.suggest_int("depth", 1, 10),
        "subsample": trial.suggest_float("subsample", 0.05, 1.0),
        "colsample_bylevel": trial.suggest_float("colsample_bylevel", 0.05, 1.0),
        "min_data_in_leaf": trial.suggest_int("min_data_in_leaf", 1, 100),
        "early_stopping_rounds": trial.suggest_int("early_stopping_rounds", 50, 80)
    }

    cb = CatBoostRegressor(**params, silent=True)
    cb.fit(x_train_daily, y_train_daily, eval_set = (x_val_daily, y_val_daily), cat_features = catfeat, verbose = 1000, plot = False)

    y_val_pred_daily = cb.predict(x_val_daily)
    
    rmse = mean_squared_error(y_val_daily, y_val_pred_daily, squared=False)

    return rmse

study_cb = optuna.create_study(direction='minimize')
study_cb.optimize(objective, n_trials=30)

```


```{python}
print('Best hyperparameters:', study_cb.best_params)
print('Best RMSE:', study_cb.best_value)
```


```{python}

# Best model

cb = CatBoostRegressor(n_estimators = 2620, learning_rate = 0.0487,
 depth = 5, subsample = 0.21, colsample_bylevel = 0.2, min_data_in_leaf = 21, early_stopping_rounds = 69, random_state = 123, allow_writing_files = False)

cb.fit(x_train_daily, y_train_daily, eval_set=(x_val_daily, y_val_daily), cat_features = catfeat, verbose = 500, plot = True)

```


### Feature importances

```{python}
cb.get_feature_importance(prettified=True).plot(x = "Feature Id", y = "Importances", kind = "bar")
```



### Evaluation metrics train and validation set

```{python}
y_train_pred = cb.predict(x_train_daily)
print(f"R-squared train: {round(r2_score(y_train_daily, y_train_pred),6)}")
print(f"MAPE train: {round(100*mean_absolute_percentage_error(y_train_daily, y_train_pred),2)}\n")

y_val_pred = cb.predict(x_val_daily)
print(f"R-squared validation: {round(r2_score(y_val_daily, y_val_pred),6)}")
print(f"MAPE validation: {round(100*mean_absolute_percentage_error(y_val_daily, y_val_pred),2)}")

```





# Test dataset

```{python}
x_train_daily_totalamount = pd.concat([x_train_daily.reset_index(), y_train_daily.reset_index(drop= True)], axis = 1)

x_test_daily_totalamount = pd.concat([x_test_daily.reset_index(), y_test_daily.reset_index(drop= True)], axis = 1)
```


```{python}
x_test_daily_totalamount, y_test_pred =  pred_test(train = x_train_daily_totalamount, test = x_test_daily_totalamount, model = cb, numfeat = numfeat, catfeat = catfeat)
```

```{python}
x_test_daily_totalamount[["date","store_name","total_amount","pred_total_amount"]]
```

```{python}
fit_overview(ytrain = y_train_daily, ytrainpred = y_train_pred, ytest = y_test_daily, ytestpred = y_test_pred)
```

